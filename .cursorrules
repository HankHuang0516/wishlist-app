
# Wishlist.ai - Agent Rules & Documentation Guide

## 0. Pre-Work Requirements (å¿…è®€)
- **ALWAYS read this file first** before starting any work.
- Based on the task type, read the corresponding documentation files listed below.

---

## ğŸ“š Documentation Reference Guide

### ä¾æ“šä»»å‹™é¡å‹é¸æ“‡è®€å–çš„æ–‡ä»¶ï¼š

| ä»»å‹™é¡å‹ | å¿…è®€æ–‡ä»¶ |
|----------|----------|
| **ä¸€èˆ¬é–‹ç™¼/åŠŸèƒ½é–‹ç™¼** | `server/src/data/FAQ.md` |
| **é€²ç‰ˆ/éƒ¨ç½²é©—è­‰** | `REGRESSION_TEST_PLAN.md` |
| **å®‰å…¨å¯©è¨ˆ** | `security/audit/Security-Audit-Prompt_Traditional-Chinese.md` |
| **å®‰å…¨æŒ‡å—** | `security/guidelines/Security-Guidelines_Traditional-Chinese.md` |
| **å®‰å…¨æŒ‡å—èªªæ˜** | `security/guidelines/Security-Guidelines-Explanation_Traditional-Chinese.md` |
| **å®‰å…¨ä¿®å¾©** | `security-fixes.md` |
| **å‰ç«¯é–‹ç™¼** | `client/README.md` |

### æ–‡ä»¶è·¯å¾‘é€ŸæŸ¥ï¼š

```
wishlist-app/
â”œâ”€â”€ .cursorrules                    # ğŸ”´ Agent è¦å‰‡ (å¿…è®€)
â”œâ”€â”€ security-fixes.md               # å®‰å…¨ä¿®å¾©ç´€éŒ„
â”œâ”€â”€ client/
â”‚   â””â”€â”€ README.md                   # å‰ç«¯èªªæ˜
â”œâ”€â”€ server/
â”‚   â””â”€â”€ src/data/
â”‚       â””â”€â”€ FAQ.md                  # â­ ç”¢å“ FAQ (ä¸€èˆ¬ä»»å‹™å¿…è®€)
â””â”€â”€ security/
    â”œâ”€â”€ audit/
    â”‚   â””â”€â”€ Security-Audit-Prompt_*.md    # å®‰å…¨å¯©è¨ˆæç¤º (16 èªè¨€)
    â””â”€â”€ guidelines/
        â”œâ”€â”€ Security-Guidelines_*.md       # å®‰å…¨æŒ‡å— (16 èªè¨€)
        â””â”€â”€ Security-Guidelines-Explanation_*.md  # æŒ‡å—èªªæ˜ (16 èªè¨€)
```

---

## ğŸ”’ Security & Operational Rules

### 1. Terminal Command Execution
- **NEVER chain commands** using `;` or `&&` (e.g., `git add . ; git commit`).
- ALWAYS execute commands sequentially in separate steps.
- **CRITICAL: FORBIDDEN CHARACTERS (Security Trigger)**
  - **These characters trigger manual permission prompts EVEN IF `SafeToAutoRun` is true.**
  - **NEVER** use them in ANY command argument (especially `git commit` messages):
    - `(` or `)` (Parentheses) -> âŒ `Fix (CSP)` âœ… `Fix CSP`
    - **Conventional Commits Warning**:
      - âŒ `fix(crawler):` -> Triggers Prompt (Parentheses)
      - âœ… `fix: crawler -` -> Safe (No Parentheses)
    - `&` (Ampersand) -> âŒ `UI & API` âœ… `UI and API`
    - `|` (Pipe) -> Remove
    - `;` (Semicolon) -> Remove
    - `$` (Dollar Sign) -> Remove
  - **Reason**: PowerShell treats these as executable blocks/operators. The IDE's security layer intercepts them before the agent's "Safe" flag can apply.
  
  - **Reason**: PowerShell treats these as executable blocks/operators. The IDE's security layer intercepts them before the agent's "Safe" flag can apply.
  
  - âŒ `git commit -m "fix(crawler): update Momo AI info (v0.0.87)"` -> **Triggers Prompt (parentheses)!**
  - âœ… `git commit -m "fix: crawler - update Momo AI info - v0.0.87"` -> **Auto-runs**

  - **Avoid `curl` with complex URLs**:
    - URLs with `?` or `&` often trigger paranoid shell checks even when quoted.
    - âŒ `curl -I "https://example.com?foo=bar&baz=1"`
    - âœ… Use `read_url_content` tool OR `node -e` scripts instead.

- **GLOBAL INSTALL REQUIRES PERMISSION** (è¨­è¨ˆå¦‚æ­¤):
  - `npm install -g` æœƒä¿®æ”¹ç³»çµ±å…¨åŸŸç‹€æ…‹ï¼Œå› æ­¤**æ°¸é éœ€è¦æ¬Šé™ç¢ºèª**ã€‚
  - é€™æ˜¯å®‰å…¨æ©Ÿåˆ¶ï¼Œä¸æ˜¯ Bugã€‚å³ä½¿ `npm` åœ¨ Allow List ä¸­ä¹Ÿä¸€æ¨£ã€‚
  - âŒ ç„¡æ³•è‡ªå‹•åŸ·è¡Œ: `npm install -g @railway/cli`
  - âœ… å¯ä»¥è‡ªå‹•åŸ·è¡Œ: `npm install express` (å°ˆæ¡ˆå…§å®‰è£)

### 2. Deployment
- **éƒ¨ç½²å‰å¿…é ˆåŸ·è¡Œ `npm run test -- --run` ç¢ºèªæ‰€æœ‰æ¸¬è©¦é€šéã€‚**
- **æ¯æ¬¡éƒ¨ç½²éƒ½å¿…é ˆæ›´æ–° `client/package.json` ç‰ˆæœ¬è™Ÿ**ï¼ˆä½¿ç”¨ `git rev-list --count HEAD` + 1ï¼‰ã€‚
- **æ‰‹å‹•è§¸ç™¼éƒ¨ç½²**ï¼špush å®Œæˆå¾Œï¼Œå†åŸ·è¡Œä¸€æ¬¡ç©º commit ä¾†ç¢ºä¿ Railway é–‹å§‹éƒ¨ç½²ï¼š
  ```
  git commit --allow-empty -m "chore: Trigger redeploy"
  git push
  ```
- The Git "Always Allow" rule is configured for `git` prefix.
- **Git commit messages**: é¿å…åœ¨ `-m` è¨Šæ¯ä¸­ä½¿ç”¨ç‰¹æ®Šå­—å…ƒï¼ˆå¦‚ `$`, `()`, `&`, `+`ï¼‰ï¼Œå› ç‚º PowerShell å¯èƒ½æœƒå°‡å…¶è§£æç‚ºè®Šæ•¸æˆ–é‹ç®—ç¬¦ï¼Œå°è‡´éœ€è¦æ¬Šé™ç¢ºèªã€‚
  - âŒ `git commit -m "feat: Add 25+ currencies"`
  - âœ… `git commit -m "feat: Add 25 currencies support"`

### 3. Environment
- Use `IPv4` first resolution for Node to avoid Railway/Gmail blocks.
- Trim whitespace from all Environment Variables.

### 4. PowerShell Pipeline Commands
- å³ä½¿å–®ç¨çš„æŒ‡ä»¤åœ¨ Allow List ä¸­ï¼ˆå¦‚ `npm`, `Select-String`, `Select-Object`ï¼‰ï¼Œ**ç®¡é“çµ„åˆæŒ‡ä»¤** ä»å¯èƒ½éœ€è¦æ‰‹å‹•ç¢ºèªã€‚
- é€™æ˜¯å› ç‚º PowerShell çš„ token åŒ¹é…æ©Ÿåˆ¶å°ç®¡é“ (`|`) çµ„åˆè¼ƒç‚ºè¬¹æ…ã€‚
- **å»ºè­°**ï¼šç›´æ¥åŸ·è¡Œç´” `npm` æŒ‡ä»¤ï¼Œä¸ç”¨ç®¡é“éæ¿¾ï¼Œä»¥ç¢ºä¿ Allow List æ­£å¸¸é‹ä½œã€‚

### 5. Railway CLI Configuration
- **ç™»å…¥å¸³è™Ÿ**: `hankhuang0516@gmail.com`
- **å°ˆæ¡ˆåç¨±**: `thorough-presence`
- **ç’°å¢ƒ**: `production`
- **Authorized Commands** (å·²è¨­å®š Allow List):
  - `railway status` - æŸ¥çœ‹å°ˆæ¡ˆç‹€æ…‹
  - `railway logs` - æŸ¥çœ‹å³æ™‚æ—¥èªŒ
  - `railway variables` - æŸ¥çœ‹ç’°å¢ƒè®Šæ•¸
  - `railway up` - éƒ¨ç½²
- **Admin API Endpoints** (ç„¡éœ€ CLI):
  - Health: `https://wishlist-app-production.up.railway.app/api/admin/health`
  - Stats: `https://wishlist-app-production.up.railway.app/api/admin/stats?key=wishlist-admin-2026`
  - Logs: `https://wishlist-app-production.up.railway.app/api/admin/crawler-logs?key=wishlist-admin-2026`

---

## ğŸŒ Multi-Language Support

å®‰å…¨ç›¸é—œæ–‡ä»¶æ”¯æ´ä»¥ä¸‹èªè¨€ï¼š
- Arabic (é˜¿æ‹‰ä¼¯æ–‡)
- Dutch (è·è˜­æ–‡)
- English (è‹±æ–‡)
- French (æ³•æ–‡)
- German (å¾·æ–‡)
- Italian (ç¾©å¤§åˆ©æ–‡)
- Japanese (æ—¥æ–‡)
- Korean (éŸ“æ–‡)
- Portuguese (è‘¡è„ç‰™æ–‡)
- Russian (ä¿„æ–‡)
- Simplified-Chinese (ç°¡é«”ä¸­æ–‡)
- Spanish (è¥¿ç­ç‰™æ–‡)
- Thai (æ³°æ–‡)
- **Traditional-Chinese (ç¹é«”ä¸­æ–‡)** â† é è¨­
- Vietnamese (è¶Šå—æ–‡)

---

## ğŸ› Known Issues / å·²çŸ¥å•é¡Œ

### Issue D10: Railway Ephemeral Filesystem (2026-01-03)
- **å•é¡Œ**ï¼šä¸‹è¼‰åœ–ç‰‡åˆ°æœ¬åœ° `/public/uploads/` å¾Œï¼Œæ¯æ¬¡éƒ¨ç½²åœ–ç‰‡éƒ½æœƒæ¶ˆå¤±
- **åŸå› **ï¼šRailway ä½¿ç”¨ ephemeral (æš«æ™‚æ€§) æª”æ¡ˆç³»çµ±ï¼Œå®¹å™¨é‡å»ºå¾Œæ‰€æœ‰é Git æª”æ¡ˆéƒ½æœƒè¢«æ¸…é™¤
- **è§£æ±ºæ–¹æ¡ˆ**ï¼šOption C - ç›´æ¥ä½¿ç”¨ Gemini è¿”å›çš„åŸå§‹åœ–ç‰‡ URLï¼Œä¸ä¸‹è¼‰åˆ°æœ¬åœ°
- **é¢¨éšª**ï¼šæŸäº›ç¶²ç«™å¯èƒ½é˜»æ“‹ hotlinking (403 éŒ¯èª¤)
- **æœªä¾†æ”¹é€²**ï¼šè€ƒæ…®ä½¿ç”¨ Cloudinary åšæŒä¹…åŒ–åœ–ç‰‡å„²å­˜

### Issue D9: Image Download User-Agent (Previous)
- **å•é¡Œ**ï¼šæŸäº›é›»å•†ç¶²ç«™é˜»æ“‹ä¼ºæœå™¨ä¸‹è¼‰åœ–ç‰‡
- **è§£æ±ºæ–¹æ¡ˆ**ï¼šä½¿ç”¨éš¨æ©Ÿ User-Agent headers (`getRandomHeaders()`)


### Issue D11: CSP Blocking External Images (2026-01-03)
- **å•é¡Œ**ï¼šGemini Fallback ä½¿ç”¨ ui-avatars.com æˆ–ç›´æ¥é€£çµå¤–éƒ¨åœ–ç‰‡æ™‚ï¼Œåœ–ç‰‡ç„¡æ³•é¡¯ç¤º
- **éŒ¯èª¤è¨Šæ¯**ï¼š`Refused to load the image ... because it violates the following Content Security Policy directive: "img-src 'self' data:"`
- **åŸå› **ï¼šHelmet é è¨­ CSP åš´æ ¼é™åˆ¶ `img-src` åƒ…å…è¨± `self` å’Œ `data:`
- **è§£æ±ºæ–¹æ¡ˆ**ï¼šåœ¨ `server/src/index.ts` çš„ `helmet()` è¨­å®šä¸­ï¼Œæ˜ç¢ºé–‹æ”¾ `img-src` åŒ…å« `https:`, `http:`, `*`
- **é é˜²**ï¼šæœªä¾†æ–°å¢å¤–éƒ¨è³‡æºå¼•ç”¨æ™‚ï¼Œéœ€åŒæ­¥æª¢æŸ¥ Helmet CSP è¨­å®š

### Issue D12: Google Image Search Fallback (2026-01-03)
- **å•é¡Œ**ï¼šå•†å“åœ–ç‰‡é¡¯ç¤ºç‚º ui-avatars æ–‡å­—åœ– ("Switch 2...") è€ŒéçœŸå¯¦ç”¢å“åœ–
- **åŸå› **ï¼šAI å˜—è©¦ä½¿ç”¨ `searchGoogleImage` å°‹æ‰¾åœ–ç‰‡å¤±æ•—ï¼Œç³»çµ±è‡ªå‹• Fallback åˆ° ui-avatars
- **å¯èƒ½åŸå› **ï¼š
  1. **Quota Exceeded**: Google Custom Search API æ¯æ—¥å…è²»é¡åº¦åƒ… 100 æ¬¡
  2. **Missing Keys**: `GOOGLE_API_KEY` æˆ– `GOOGLE_CSE_ID` æœªè¨­å®šæˆ–ç„¡æ•ˆ
  3. **No Results**: æœå°‹é—œéµå­—æ‰¾ä¸åˆ°ç›¸é—œåœ–ç‰‡
- **æª¢æŸ¥æ–¹å¼**ï¼šæŸ¥çœ‹ `railway logs` æœå°‹ "Google Image Search failed"
